<!DOCTYPE html>
<html>
<head>
    <title>–¢–µ—Å—Ç –ø–æ–∫—É–ø–æ–∫ BBS</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: white; }
        .test { margin: 20px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .success { border-left: 4px solid #4CAF50; }
        .error { border-left: 4px solid #f44336; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 4px; }
        button:hover { background: #45a049; }
        pre { background: #000; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üß™ –¢–µ—Å—Ç –≤—Å–µ—Ö —Å–ø–æ—Å–æ–±–æ–≤ –ø–æ–∫—É–ø–∫–∏ BBS</h1>
    <p>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ backend —Ñ—É–Ω–∫—Ü–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π —á–µ—Ä–µ–∑ –≤—Å–µ —Å–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã</p>
    
    <button onclick="testAllPurchases()">üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã</button>
    <button onclick="clearResults()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
    
    <div id="results"></div>

    <script>
        const API_URL = 'https://functions.poehali.dev/c17a5ef7-015a-48f6-9679-2e3a240bcee7';
        const USER_ID = 1;

        async function testPurchase(currency, amount, description) {
            const testName = `–ü–æ–∫—É–ø–∫–∞ —á–µ—Ä–µ–∑ ${currency}`;
            const startTime = Date.now();
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: USER_ID,
                        type: 'buy',
                        amount: amount,
                        currency: currency,
                        description: description
                    })
                });
                
                const data = await response.json();
                const duration = Date.now() - startTime;
                
                if (response.ok) {
                    showResult(testName, 'success', {
                        status: '‚úÖ –£—Å–ø–µ—à–Ω–æ',
                        amount: `${amount} BBS`,
                        currency: currency,
                        description: description,
                        duration: `${duration}ms`,
                        transaction_id: data.transaction.id,
                        response: data
                    });
                    return true;
                } else {
                    showResult(testName, 'error', {
                        status: '‚ùå –û—à–∏–±–∫–∞',
                        error: data.error,
                        duration: `${duration}ms`
                    });
                    return false;
                }
            } catch (error) {
                showResult(testName, 'error', {
                    status: '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏',
                    error: error.message
                });
                return false;
            }
        }

        async function testAllPurchases() {
            clearResults();
            
            const tests = [
                { currency: 'RUB', amount: 5, desc: '–ü–æ–∫—É–ø–∫–∞ 5 BBS –∑–∞ ‚ÇΩ500 (–ü—Ä—è–º–∞—è –æ–ø–ª–∞—Ç–∞ —Ä—É–±–ª—è–º–∏)' },
                { currency: 'USDT', amount: 10, desc: '–ü–æ–∫—É–ø–∫–∞ 10 BBS –∑–∞ ~10.5 USDT —á–µ—Ä–µ–∑ TON Network' },
                { currency: 'PHONE', amount: 3, desc: '–ü–æ–∫—É–ø–∫–∞ 3 BBS –∑–∞ ‚ÇΩ300 —á–µ—Ä–µ–∑ –°–ë–ü (–°–±–µ—Ä–±–∞–Ω–∫/–û–∑–æ–Ω)' },
                { currency: 'MEMECOIN', amount: 8, desc: '–ü–æ–∫—É–ø–∫–∞ 8 BBS –∑–∞ 80 –º–µ–º–∫–æ–∏–Ω–æ–≤ (–∫—É—Ä—Å 10 MC = 1 BBS)' },
                { currency: 'RUB', amount: 20, desc: '–ü–æ–∫—É–ø–∫–∞ 20 BBS –∑–∞ ‚ÇΩ2000 (–ö—Ä—É–ø–Ω–∞—è —Å—É–º–º–∞)' }
            ];

            let passed = 0;
            let failed = 0;

            for (const test of tests) {
                const result = await testPurchase(test.currency, test.amount, test.desc);
                if (result) passed++;
                else failed++;
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ç–æ–≥–∏
            const summary = document.createElement('div');
            summary.className = 'test ' + (failed === 0 ? 'success' : 'error');
            summary.innerHTML = `
                <h3>üìä –ò—Ç–æ–≥–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
                <p><strong>–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:</strong> ${tests.length}</p>
                <p><strong>‚úÖ –£—Å–ø–µ—à–Ω–æ:</strong> ${passed}</p>
                <p><strong>‚ùå –ü—Ä–æ–≤–∞–ª–µ–Ω–æ:</strong> ${failed}</p>
                <p><strong>–ü—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—Ö–∞:</strong> ${Math.round(passed / tests.length * 100)}%</p>
            `;
            document.getElementById('results').insertBefore(summary, document.getElementById('results').firstChild);

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
            await loadTransactionHistory();
        }

        async function loadTransactionHistory() {
            try {
                const response = await fetch(`${API_URL}?user_id=${USER_ID}`);
                const data = await response.json();
                
                showResult('–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', 'success', {
                    status: 'üìú –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞',
                    total_transactions: data.transactions.length,
                    transactions: data.transactions.slice(0, 10)
                });
            } catch (error) {
                showResult('–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π', 'error', {
                    status: '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å',
                    error: error.message
                });
            }
        }

        function showResult(testName, status, data) {
            const resultsDiv = document.getElementById('results');
            const testDiv = document.createElement('div');
            testDiv.className = `test ${status}`;
            testDiv.innerHTML = `
                <h3>${testName}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
            resultsDiv.appendChild(testDiv);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }
    </script>
</body>
</html>
